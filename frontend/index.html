<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kraken AI Trading Bot</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>‚ö°</text></svg>"
      type="image/svg+xml"
    />
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/components.css" />
  </head>

  <body
    class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 min-h-screen text-gray-100"
  >
    <div x-data="app()" x-init="init()" class="min-h-screen flex flex-col">
      <!-- Header/Navigation -->
      <nav class="bg-gray-950 border-b border-gray-700">
        <div
          class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
        >
          <div class="flex items-center gap-2">
            <span class="text-2xl font-bold text-green-500">‚ö°</span>
            <h1 class="text-xl font-bold">Kraken AI Trading Bot</h1>
          </div>
          <div class="flex items-center gap-6">
            <div x-show="!loading && status" class="flex items-center gap-2">
              <span
                class="inline-block w-3 h-3 bg-green-500 rounded-full animate-pulse"
              ></span>
              <span class="text-sm text-green-400">Connected</span>
            </div>
            <div x-show="loading" class="text-blue-400 text-sm">Loading...</div>
            <div class="text-xs text-gray-500">
              Next trading cycle in:
              <span x-text="formatTime(schedulerCountdown)"></span>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-8">
        <!-- Top KPIs - Bot Status & Portfolio -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <!-- Bot Status -->
          <div
            class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-gray-700 p-6 shadow-lg"
          >
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-gray-400">Bot Status</div>
              <span
                class="inline-block w-3 h-3 bg-green-500 rounded-full animate-pulse"
              ></span>
            </div>
            <div
              class="text-3xl font-bold text-green-400 mb-1"
              x-text="botStatus.is_running ? 'ACTIVE' : 'INACTIVE'"
            ></div>
            <div class="text-xs text-gray-500">
              <span x-text="schedulerStatus.trading_mode || 'PAPER'"></span>
              mode
            </div>
          </div>

          <!-- BTC Balance -->
          <div
            class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-gray-700 p-6 shadow-lg"
          >
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-gray-400">BTC Balance</div>
              <span class="text-2xl">‚Çø</span>
            </div>
            <div
              class="text-2xl font-bold text-orange-400 mb-1"
              x-text="botStatus.btc_balance.toFixed(8)"
            ></div>
            <div class="text-xs text-gray-500">Bitcoin holdings</div>
          </div>

          <!-- USD Balance -->
          <div
            class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-gray-700 p-6 shadow-lg"
          >
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-gray-400">USD Balance</div>
              <span class="text-2xl">üíµ</span>
            </div>
            <div
              class="text-2xl font-bold text-blue-400 mb-1"
              x-text="'$' + botStatus.usd_balance.toFixed(2)"
            ></div>
            <div class="text-xs text-gray-500">Available to trade</div>
          </div>

          <!-- Total Portfolio -->
          <div
            class="bg-gradient-to-br from-purple-900/30 to-gray-900 rounded-xl border border-purple-700/50 p-6 shadow-lg"
          >
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-purple-300">Total Value</div>
              <span class="text-2xl">üíé</span>
            </div>
            <div
              class="text-2xl font-bold text-purple-400 mb-1"
              x-text="'$' + totalPortfolio.toFixed(2)"
            ></div>
            <div class="text-xs text-purple-300/70">Portfolio value</div>
          </div>
        </div>

        <!-- Next Cycle & Manual Control -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
          <!-- Next Cycle Countdown -->
          <div
            class="bg-gradient-to-br from-blue-900/30 to-gray-900 rounded-xl border border-blue-700/50 p-6 shadow-lg"
          >
            <div class="text-sm font-medium text-blue-300 mb-3">
              ‚è∞ Next Trading Cycle
            </div>
            <div
              class="text-4xl font-bold text-blue-400 mb-2"
              x-text="formatTime(schedulerCountdown)"
            ></div>
            <div
              class="text-xs text-blue-300/70"
              x-text="schedulerStatus.next_run_time ? new Date(schedulerStatus.next_run_time).toLocaleString() : 'Not scheduled'"
            ></div>
          </div>

          <!-- Last Cycle Info -->
          <div
            class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-gray-700 p-6 shadow-lg"
          >
            <div class="text-sm font-medium text-gray-400 mb-3">
              üìä Last Cycle
            </div>
            <div
              class="text-lg font-mono text-gray-200 mb-2"
              x-text="schedulerStatus.last_cycle ? new Date(schedulerStatus.last_cycle).toLocaleTimeString() : 'Never'"
            ></div>
            <div class="flex items-center gap-2">
              <span
                :class="schedulerStatus.last_cycle_result?.status === 'success' ? 'bg-green-600' : schedulerStatus.last_cycle_result?.status === 'error' ? 'bg-red-600' : 'bg-yellow-600'"
                class="px-2 py-1 rounded text-xs font-bold capitalize"
                x-text="schedulerStatus.last_cycle_result?.status || 'pending'"
              ></span>
              <span
                x-show="schedulerStatus.last_cycle_result?.trigger"
                :class="schedulerStatus.last_cycle_result?.trigger === 'manual' ? 'bg-blue-600' : 'bg-purple-600'"
                class="px-2 py-1 rounded text-xs font-bold capitalize"
                x-text="schedulerStatus.last_cycle_result?.trigger"
              ></span>
              <span
                class="text-xs text-gray-500"
                x-text="timeSinceLastCycle"
              ></span>
            </div>
          </div>

          <!-- Manual Control -->
          <div
            class="bg-gradient-to-br from-green-900/30 to-gray-900 rounded-xl border border-green-700/50 p-6 shadow-lg flex flex-col justify-center"
          >
            <button
              @click="runManualCycle()"
              :disabled="manualCycleRunning"
              :class="manualCycleRunning ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
              class="w-full px-6 py-3 rounded-lg font-bold transition-colors flex items-center justify-center gap-2"
            >
              <span x-show="!manualCycleRunning" class="text-lg"
                >‚ñ∂Ô∏è Run Manual Cycle</span
              >
              <span x-show="manualCycleRunning" class="flex items-center gap-2">
                <svg
                  class="animate-spin h-5 w-5"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                Running...
              </span>
            </button>
            <div class="text-xs text-center text-green-300/70 mt-2">
              Execute cycle immediately
            </div>
          </div>
        </div>

        <!-- Recent Trades (Most Important) -->
        <div
          class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl border border-orange-700/50 p-6 mb-6 shadow-lg"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span>üí∞</span> Recent Trades
            </h2>
            <button
              @click="refreshStatus()"
              class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              üîÑ Refresh
            </button>
          </div>
          <div x-show="trades.length > 0" class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-700/50 border-b border-gray-600">
                <tr>
                  <th class="px-4 py-3 text-left">Trade ID</th>
                  <th class="px-4 py-3 text-left">Type</th>
                  <th class="px-4 py-3 text-left">Entry Price</th>
                  <th class="px-4 py-3 text-left">Exit Price</th>
                  <th class="px-4 py-3 text-left">Quantity</th>
                  <th class="px-4 py-3 text-left">P/L</th>
                  <th class="px-4 py-3 text-left">Status</th>
                  <th class="px-4 py-3 text-left">Date</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700">
                <template
                  x-for="(trade, index) in trades"
                  :key="'trade-' + index"
                >
                  <tr class="hover:bg-gray-700/30 transition-colors">
                    <td
                      class="px-4 py-3 font-mono text-xs text-gray-400"
                      x-text="trade.trade_id"
                    ></td>
                    <td class="px-4 py-3">
                      <span
                        :class="trade.order_type === 'BUY' ? 'bg-green-600' : 'bg-red-600'"
                        class="px-2 py-1 rounded text-xs font-bold"
                        x-text="trade.order_type"
                      >
                      </span>
                    </td>
                    <td
                      class="px-4 py-3 text-orange-400 font-semibold"
                      x-text="trade.entry_price ? '$' + parseFloat(trade.entry_price).toFixed(2) : 'N/A'"
                    ></td>
                    <td
                      class="px-4 py-3 text-blue-400 font-semibold"
                      x-text="trade.exit_price ? '$' + parseFloat(trade.exit_price).toFixed(2) : '-'"
                    ></td>
                    <td
                      class="px-4 py-3 font-mono text-xs"
                      x-text="trade.quantity ? parseFloat(trade.quantity).toFixed(8) + ' BTC' : 'N/A'"
                    ></td>
                    <td class="px-4 py-3">
                      <span
                        :class="trade.profit_loss > 0 ? 'text-green-400' : trade.profit_loss < 0 ? 'text-red-400' : 'text-gray-400'"
                        class="font-bold"
                        x-text="trade.profit_loss ? '$' + parseFloat(trade.profit_loss).toFixed(2) : '-'"
                      >
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <span
                        :class="{
                          'bg-green-600': trade.status === 'CLOSED',
                          'bg-blue-600': trade.status === 'OPEN',
                          'bg-gray-600': trade.status === 'CANCELLED'
                        }"
                        class="px-2 py-1 rounded text-xs font-semibold"
                        x-text="trade.status"
                      >
                      </span>
                    </td>
                    <td
                      class="px-4 py-3 text-xs text-gray-400"
                      x-text="new Date(trade.created_at).toLocaleString()"
                    ></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div
            x-show="trades.length === 0"
            class="text-gray-500 text-center py-12"
          >
            <div class="text-4xl mb-3">üìä</div>
            <div class="text-lg">No trades executed yet</div>
            <div class="text-sm mt-2">Waiting for buy signals...</div>
          </div>
        </div>

        <!-- Trading Cycles History -->
        <div
          class="bg-gray-800 rounded-xl border border-gray-700 p-6 mb-6 shadow-lg"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span>üìä</span> Trading Cycles History
            </h2>
            <button
              @click="fetchCycles()"
              class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
            >
              üîÑ Refresh
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-700/50 border-b border-gray-600">
                <tr>
                  <th class="px-4 py-3 text-left">Time</th>
                  <th class="px-4 py-3 text-left">Price</th>
                  <th class="px-4 py-3 text-left">Indicators</th>
                  <th class="px-4 py-3 text-left">AI Signal</th>
                  <th class="px-4 py-3 text-left">Action</th>
                  <th class="px-4 py-3 text-left">Balances</th>
                  <th class="px-4 py-3 text-left">Mode</th>
                  <th class="px-4 py-3 text-right">Time (ms)</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700">
                <template x-for="cycle in cycles" :key="cycle.id">
                  <tr class="hover:bg-gray-700/30 transition-colors">
                    <td class="px-4 py-3 text-gray-300">
                      <div
                        class="text-xs"
                        x-text="new Date(cycle.timestamp).toLocaleString()"
                      ></div>
                    </td>
                    <td class="px-4 py-3">
                      <div
                        class="font-semibold text-orange-400"
                        x-text="'$' + cycle.btc_price.toFixed(2)"
                      ></div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="text-xs space-y-1">
                        <div>
                          <span class="text-gray-500">EMA20:</span>
                          <span x-text="cycle.ema20.toFixed(2)"></span>
                        </div>
                        <div>
                          <span class="text-gray-500">EMA50:</span>
                          <span x-text="cycle.ema50.toFixed(2)"></span>
                        </div>
                        <div>
                          <span class="text-gray-500">RSI:</span>
                          <span x-text="cycle.rsi14.toFixed(2)"></span>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <span
                          class="px-2 py-1 rounded text-xs font-semibold"
                          :class="{
                                                    'bg-green-600': cycle.ai_signal === 'BUY',
                                                    'bg-red-600': cycle.ai_signal === 'SELL',
                                                    'bg-gray-600': cycle.ai_signal === 'HOLD'
                                                }"
                          x-text="cycle.ai_signal"
                        >
                        </span>
                        <span
                          class="text-xs text-gray-400"
                          x-text="(cycle.ai_confidence * 100).toFixed(0) + '%'"
                        ></span>
                      </div>
                      <div
                        class="text-xs text-gray-500 mt-1 max-w-xs truncate cursor-help"
                        x-text="cycle.ai_reason"
                        x-show="cycle.ai_reason"
                        :title="cycle.ai_reason"
                      ></div>
                    </td>
                    <td class="px-4 py-3">
                      <span
                        class="px-2 py-1 rounded text-xs font-bold"
                        :class="{
                                                'bg-green-600': cycle.action === 'BOUGHT',
                                                'bg-red-600': cycle.action === 'SOLD',
                                                'bg-yellow-600': cycle.action === 'HOLD',
                                                'bg-red-800': cycle.action === 'ERROR' || cycle.action.includes('FAILED')
                                            }"
                        x-text="cycle.action"
                      >
                      </span>
                      <div
                        class="text-xs text-gray-500 mt-1"
                        x-text="cycle.trade_id"
                        x-show="cycle.trade_id"
                      ></div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="text-xs space-y-1">
                        <div>
                          <span
                            class="text-orange-400"
                            x-text="cycle.btc_balance.toFixed(8)"
                          ></span>
                          BTC
                        </div>
                        <div>
                          <span
                            class="text-blue-400"
                            x-text="'$' + cycle.usd_balance.toFixed(2)"
                          ></span>
                          USD
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <span
                        class="px-2 py-1 rounded text-xs font-semibold"
                        :class="cycle.trading_mode === 'PAPER' ? 'bg-blue-600' : 'bg-purple-600'"
                        x-text="cycle.trading_mode"
                      >
                      </span>
                    </td>
                    <td class="px-4 py-3 text-right">
                      <span
                        class="text-xs text-gray-400"
                        x-text="cycle.execution_time_ms + 'ms'"
                      ></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div
              x-show="cycles.length === 0"
              class="text-gray-500 text-center py-8"
            >
              No trading cycles recorded yet
            </div>
          </div>
        </div>

        <!-- Application Logs -->
        <div
          class="bg-gray-800 rounded-xl border border-gray-700 p-6 shadow-lg"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
              <span>üìù</span> Application Logs
            </h2>
            <div class="flex gap-2">
              <select
                x-model="logLevel"
                @change="fetchLogs()"
                class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
              >
                <option value="">All Levels</option>
                <option value="INFO">INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
              </select>
              <button
                @click="fetchLogs()"
                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
              >
                üîÑ Refresh
              </button>
              <button
                @click="toggleAutoRefreshLogs()"
                :class="autoRefreshLogs ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 hover:bg-gray-500'"
                class="px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
              >
                <span x-show="autoRefreshLogs">‚è∏Ô∏è Pause</span>
                <span x-show="!autoRefreshLogs">‚ñ∂Ô∏è Auto</span>
              </button>
            </div>
          </div>
          <div
            class="bg-gray-900 rounded-lg p-4 font-mono text-xs max-h-96 overflow-y-auto border border-gray-700"
            id="logs-container"
          >
            <template x-for="(log, index) in logs" :key="index">
              <div
                class="py-1 border-b border-gray-800 hover:bg-gray-800/50 transition-colors"
              >
                <span
                  class="text-gray-500"
                  x-text="new Date(log.timestamp).toLocaleTimeString()"
                ></span>
                <span
                  :class="{
                                'text-blue-400': log.level === 'INFO',
                                'text-yellow-400': log.level === 'WARNING',
                                'text-red-400': log.level === 'ERROR',
                                'text-gray-400': !['INFO', 'WARNING', 'ERROR'].includes(log.level)
                            }"
                  x-text="'[' + log.level + ']'"
                ></span>
                <span class="text-gray-300" x-text="log.message"></span>
              </div>
            </template>
            <div
              x-show="logs.length === 0"
              class="text-gray-500 text-center py-8"
            >
              No logs available
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="border-t border-gray-700 bg-gray-950 mt-8">
        <div
          class="max-w-7xl mx-auto px-4 py-4 text-center text-sm text-gray-500"
        >
          Kraken AI Trading Bot v1.0.0 | Last update:
          <span x-text="new Date().toLocaleTimeString()"></span>
        </div>
      </footer>
    </div>

    <script src="./stores/auth.js"></script>
    <script src="./stores/app.js"></script>
    <script src="./utils/api.js"></script>
    <script src="./components/ui/toast.js"></script>

    <script>
      function app() {
        return {
          loading: true,
          status: null,
          countdown: 30,
          tradingCountdown: 3600,
          schedulerCountdown: 0, // Start at 0, ser√° actualizado en init()
          lastTradingTime: Date.now(),
          botStatus: { is_running: false, btc_balance: 0, usd_balance: 0 },
          trades: [],
          signals: [],
          cycles: [],
          schedulerStatus: {
            running: false,
            seconds_until_next: 0,
            next_run_time: null,
            last_cycle: null,
            last_cycle_result: {
              status: "pending",
              error: null,
              trigger: null
            },
          },
          lastUpdate: "Never",
          manualCycleRunning: false,
          logs: [],
          logLevel: "",
          autoRefreshLogs: true,

          get timeSinceLastCycle() {
            if (!this.schedulerStatus.last_cycle) return "-";
            const lastTime = new Date(
              this.schedulerStatus.last_cycle
            ).getTime();
            const now = Date.now();
            const diff = Math.floor((now - lastTime) / 1000);
            const mins = Math.floor(diff / 60);
            const secs = diff % 60;
            return `${mins}m ${secs}s ago`;
          },

          formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
          },

          get totalPortfolio() {
            // Assuming BTC price needs to be fetched
            return this.botStatus.usd_balance;
          },

          async init() {
            // Wait for initial status to load
            await this.refreshStatus();
            await this.fetchLogs();
            await this.fetchCycles();

            // Refresh status every 30 seconds from backend
            setInterval(() => this.refreshStatus(), 30000);

            // Refresh logs every 5 seconds if auto-refresh enabled
            setInterval(() => {
              if (this.autoRefreshLogs) {
                this.fetchLogs();
              }
            }, 5000);

            // Refresh cycles every 10 seconds
            setInterval(() => this.fetchCycles(), 10000);

            // Local countdown decrement (every second)
            setInterval(() => {
              if (this.schedulerCountdown > 0) {
                this.schedulerCountdown--;
              }
            }, 1000);
          },

          async refreshStatus() {
            try {
              // 1. Fetch scheduler status FIRST (critical for countdown)
              const schedulerResp = await fetch("/api/v1/bot/scheduler/status");
              if (schedulerResp.ok) {
                const schedulerData = await schedulerResp.json();
                this.schedulerStatus = schedulerData;
                
                console.log("[SCHEDULER] Full data:", schedulerData);
                console.log("[SCHEDULER] Last cycle:", schedulerData.last_cycle);
                console.log("[SCHEDULER] Last cycle result:", schedulerData.last_cycle_result);

                // Update countdown - this is the key line
                if (typeof schedulerData.seconds_until_next === "number") {
                  this.schedulerCountdown = Math.max(
                    0,
                    schedulerData.seconds_until_next
                  );
                  console.log(
                    `[SCHEDULER] Updated countdown: ${this.schedulerCountdown}s, next_run: ${schedulerData.next_run_time}`
                  );
                }
              }

              // 2. Fetch dashboard status
              const dashResp = await fetch("/api/v1/bot/dashboard");
              if (dashResp.ok) {
                const dashboard = await dashResp.json();
                this.botStatus = {
                  is_running: dashboard.mode === "PAPER",
                  btc_balance: parseFloat(dashboard.btc_balance) || 0,
                  usd_balance: parseFloat(dashboard.usd_balance) || 0,
                };

                // 3. Fetch trades filtered by mode
                try {
                  const mode = dashboard.mode || "PAPER";
                  const tradesResp = await fetch(
                    `/api/v1/trades?mode=${mode}&limit=50`
                  );
                  if (tradesResp.ok) {
                    const tradesData = await tradesResp.json();
                    this.trades = Array.isArray(tradesData) ? tradesData : [];
                  }
                } catch (e) {
                  console.warn("Error fetching trades:", e);
                }
              }

              // 4. Fetch signals
              try {
                const signalsResp = await fetch("/api/v1/bot/signals");
                if (signalsResp.ok) {
                  const signalsData = await signalsResp.json();
                  this.signals = Array.isArray(signalsData) ? signalsData : [];
                }
              } catch (e) {
                console.warn("Error fetching signals:", e);
              }

              this.lastUpdate = new Date().toLocaleTimeString();
              this.loading = false;
            } catch (err) {
              console.error("Critical error in refreshStatus:", err);
              this.loading = false;
            }
          },

          async startBot() {
            try {
              await fetch("/api/v1/bot/start", { method: "POST" });
              this.refreshStatus();
            } catch (err) {
              console.error("Error starting bot:", err);
            }
          },

          async stopBot() {
            try {
              await fetch("/api/v1/bot/stop", { method: "POST" });
              this.refreshStatus();
            } catch (err) {
              console.error("Error stopping bot:", err);
            }
          },

          async runManualCycle() {
            if (this.manualCycleRunning) return;

            this.manualCycleRunning = true;
            try {
              const response = await fetch("/api/v1/bot/cycle", {
                method: "POST",
              });
              const result = await response.json();

              if (result.success) {
                console.log("‚úÖ Manual cycle completed:", result);
                // Refresh dashboard after cycle
                await this.refreshStatus();
              } else {
                console.error("‚ùå Manual cycle failed:", result.message);
              }
            } catch (err) {
              console.error("Error running manual cycle:", err);
            } finally {
              this.manualCycleRunning = false;
            }
          },

          async fetchCycles() {
            try {
              const response = await fetch("/api/v1/bot/cycles?limit=20");
              if (response.ok) {
                const data = await response.json();
                this.cycles = data || [];
              }
            } catch (err) {
              console.error("Error fetching cycles:", err);
            }
          },

          async fetchLogs() {
            try {
              const url = this.logLevel
                ? `/api/v1/bot/logs?limit=100&level=${this.logLevel}`
                : "/api/v1/bot/logs?limit=100";

              const response = await fetch(url);
              if (response.ok) {
                const data = await response.json();
                this.logs = data.logs || [];

                // Auto-scroll to bottom
                setTimeout(() => {
                  const container = document.getElementById("logs-container");
                  if (container) {
                    container.scrollTop = container.scrollHeight;
                  }
                }, 100);
              }
            } catch (err) {
              console.error("Error fetching logs:", err);
            }
          },

          toggleAutoRefreshLogs() {
            this.autoRefreshLogs = !this.autoRefreshLogs;
          },
        };
      }
    </script>
  </body>
</html>
